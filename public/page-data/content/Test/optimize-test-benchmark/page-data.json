{"componentChunkName":"component---src-templates-blog-post-js","path":"/content/Test/optimize-test-benchmark/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Blog","author":"Kim"}},"markdownRemark":{"id":"7bf6104b-77ef-57e8-8c95-f86490c09d78","excerpt":"前言 随着互联网时代的飞速发展，用户对产品性能越来越关注，特别是服务端程序，一个功能跑几十秒实在是无法忍受，于是总是想尽各种办法去提高性能，也包括 API 层面的选择，当然性能测试是我们选择的重要依据。 Benchmark Benchmark 是 Node.js 上比较流行的性能测试工具，其链式调用的 API…","html":"<h3>前言</h3>\n<p>随着互联网时代的飞速发展，用户对产品性能越来越关注，特别是服务端程序，一个功能跑几十秒实在是无法忍受，于是总是想尽各种办法去提高性能，也包括 API 层面的选择，当然性能测试是我们选择的重要依据。</p>\n<h3>Benchmark</h3>\n<p>Benchmark 是 Node.js 上比较流行的性能测试工具，其链式调用的 API 也让我们写的更加顺畅，下面来尝鲜一下 Benchmark 做性能测试的乐趣。</p>\n<p>假如说我们要做一个字符串转数字使用哪种方式比较快的测试，有三种方式：</p>\n<ul>\n<li>使用<code class=\"language-text\">+</code>转换</li>\n<li>使用<code class=\"language-text\">parseInt</code>转换</li>\n<li>使用<code class=\"language-text\">Number</code>构造函数转换</li>\n</ul>\n<p>我们来对上面三个方式写三个方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">useAdd</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">str</span> <span class=\"token operator\">=></span> <span class=\"token operator\">+</span>str\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">useParseInt</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">str</span> <span class=\"token operator\">=></span> <span class=\"token function\">parseInt</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">,</span> <span class=\"token number\">10</span><span class=\"token punctuation\">)</span>\n\nexports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">useNumber</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">str</span> <span class=\"token operator\">=></span> <span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>str<span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>安装 benchmark.js</strong></p>\n<blockquote>\n<p>npm install benchmark —save-dev or yarn add benchmark —dev</p>\n</blockquote>\n<p>引入 benchmark 并实例化 Suite 类</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> Benchmark <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'benchmark'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> suite <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Benckmark<span class=\"token punctuation\">.</span>Suite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>开始写测试用例</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> useAdd<span class=\"token punctuation\">,</span> useNumber<span class=\"token punctuation\">,</span> useParseInt <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./string2number.js'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> Benchmark <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'benchmark'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> suite <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Benckmark<span class=\"token punctuation\">.</span>Suite</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> number <span class=\"token operator\">=</span> <span class=\"token string\">'100'</span>\n\n<span class=\"token comment\">//测试用例</span>\nsuite\n  <span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'+'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">useAdd</span><span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'parseInt'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">useParseInt</span><span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Number'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">useNumber</span><span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'cycle'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//测试跑完输出数据</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'complete'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Fastest is </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fastest'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> async<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>上面在 suite 实例了使用了三个方法，分别是：add、on、run。</p>\n<ul>\n<li>add：add 方法用于将一个测试用例添加到测试数组里面，并且实例化一个 Event 事件。</li>\n<li>on：顾名思义就是用于监听 add 方法实例化的 Event 事件，并且有多重类型，这里写了两个类型：<code class=\"language-text\">cycle</code>和<code class=\"language-text\">complete</code>，cycle 用于监听每一个测试是否跑完，在这里输出单个用例的测试信息；complete 用于监听整体测试是否完成，在这里可以找出执行最快的那一个。</li>\n<li>run：run 方法用于启动测试，之前的工作都是在准备，到这里才开始正式启动，传入<code class=\"language-text\">async:true</code>使用异步的方式启动测试。</li>\n</ul>\n<p><strong>执行测试</strong></p>\n<blockquote>\n<p>node benchmark.js</p>\n</blockquote>\n<p><strong>测试结果</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74f01921ffb07ae1e4a70c9b979ff181/030a1/1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 14.14141414141414%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAADABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABzIDFYy//xAAXEAADAQAAAAAAAAAAAAAAAAAAAREC/9oACAEBAAEFAqzTcP/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABYQAQEBAAAAAAAAAAAAAAAAADEAEP/aAAgBAQAGPwJnP//EABgQAQEBAQEAAAAAAAAAAAAAAAEAESFR/9oACAEBAAE/Icl6kDVa+t//2gAMAwEAAgADAAAAEAQ//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRAAAgMBAAAAAAAAAAAAAAAAAAERIVHx/9oACAEBAAE/EGgJCnScBeneP//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/74f01921ffb07ae1e4a70c9b979ff181/88218/1.jpg\"\n        srcset=\"/static/74f01921ffb07ae1e4a70c9b979ff181/7237a/1.jpg 148w,\n/static/74f01921ffb07ae1e4a70c9b979ff181/0cfdf/1.jpg 295w,\n/static/74f01921ffb07ae1e4a70c9b979ff181/88218/1.jpg 590w,\n/static/74f01921ffb07ae1e4a70c9b979ff181/77d57/1.jpg 885w,\n/static/74f01921ffb07ae1e4a70c9b979ff181/5a917/1.jpg 1180w,\n/static/74f01921ffb07ae1e4a70c9b979ff181/030a1/1.jpg 1188w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n输出了每个用例的信息，分别执行了 81、82、86 个样本，可以看出使用<code class=\"language-text\">+</code>是最快的。</p>\n<p><strong>end</strong></p>","frontmatter":{"title":"Benchmark写性能测试","date":"October 13, 2019","description":"使用Benchmark初次做性能测试","category":"Test"}}},"pageContext":{"slug":"/content/Test/optimize-test-benchmark/","previous":{"fields":{"slug":"/content/Webpack/webpack-scope-hoisting/"},"frontmatter":{"title":"Webpack模块化的问题及Scope hoisting原理"}},"next":{"fields":{"slug":"/content/Webpack/webpck-thread-cary/"},"frontmatter":{"title":"深入理解webpack痛点及解决方案"}}}}}