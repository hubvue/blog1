{"componentChunkName":"component---src-templates-blog-post-js","path":"/content/Webpack/webpack-scope-hoisting/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Blog","author":"Kim"}},"markdownRemark":{"id":"11eacd59-e2ad-5dea-aad5-eeee9acdebf5","excerpt":"webpack 产出物存在的问题 webpack 万物皆模块的理念，每一个 js 都是一个 JavaScript 模块。一个 bundle 是由多个 module 合成的，一个 bundle 是一个 js 文件，所以 webpack 自己实现了一套 commonjs 规范用于让 js…","html":"<h2>webpack 产出物存在的问题</h2>\n<p>webpack 万物皆模块的理念，每一个 js 都是一个 JavaScript 模块。一个 bundle 是由多个 module 合成的，一个 bundle 是一个 js 文件，所以 webpack 自己实现了一套 commonjs 规范用于让 js 成为一个独立的模块。</p>\n<p>来一个 🌰：\n比如说有 3 个模块，index.js、add.js、sum.js</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//add.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> a <span class=\"token operator\">+</span> b</code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sum.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token parameter\">arr</span> <span class=\"token operator\">=></span> arr<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">pre<span class=\"token punctuation\">,</span> item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> pre <span class=\"token operator\">+</span> item<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//index.js</span>\n<span class=\"token keyword\">import</span> sum <span class=\"token keyword\">from</span> <span class=\"token string\">'./sum'</span>\n<span class=\"token keyword\">import</span> add <span class=\"token keyword\">from</span> <span class=\"token string\">'./add'</span>\n\n<span class=\"token keyword\">let</span> a <span class=\"token operator\">=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\n  b <span class=\"token operator\">=</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span>\n  arr <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">]</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>a<span class=\"token punctuation\">,</span> b<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">sum</span><span class=\"token punctuation\">(</span>arr<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>打出来的代码如下(删除一些无用的代码)：</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">modules</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> installedModules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">__webpack_require__</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">moduleId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>exports\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      i<span class=\"token punctuation\">:</span> moduleId<span class=\"token punctuation\">,</span>\n      l<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      exports<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    modules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>\n      module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n      module<span class=\"token punctuation\">,</span>\n      module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n      __webpack_require__\n    <span class=\"token punctuation\">)</span>\n    module<span class=\"token punctuation\">.</span>l <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">__webpack_require__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>__webpack_require__<span class=\"token punctuation\">.</span>s <span class=\"token operator\">=</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/***/</span> <span class=\"token string\">'./src/add.js'</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">/***/</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">module<span class=\"token punctuation\">,</span>\n    __webpack_exports__<span class=\"token punctuation\">,</span>\n    __webpack_require__</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'use strict'</span>\n    <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'__webpack_require__.r(__webpack_exports__);\\n// add.js\\n/* harmony default export */ __webpack_exports__[\"default\"] = ((a, b) => a + b);\\n\\n\\n//# sourceURL=webpack:///./src/add.js?'</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">/***/</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">/***/</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">/***/</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">module<span class=\"token punctuation\">,</span>\n    __webpack_exports__<span class=\"token punctuation\">,</span>\n    __webpack_require__</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'use strict'</span>\n    <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'__webpack_require__.r(__webpack_exports__);\\n/* harmony import */ var _sum__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./sum */ \"./src/sum.js\");\\n/* harmony import */ var _add__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ./add */ \"./src/add.js\");\\n\\n\\n\\nlet a = 1,\\n  b = 2,\\n  arr = [1, 2, 3, 4, 5]\\n\\nconsole.log(Object(_add__WEBPACK_IMPORTED_MODULE_1__[\"default\"])(a, b))\\nconsole.log(Object(_sum__WEBPACK_IMPORTED_MODULE_0__[\"default\"])(arr))\\n\\n\\n//# sourceURL=webpack:///./src/index.js?'</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">/***/</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\n  <span class=\"token comment\">/***/</span> <span class=\"token string\">'./src/sum.js'</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">/***/</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">module<span class=\"token punctuation\">,</span>\n    __webpack_exports__<span class=\"token punctuation\">,</span>\n    __webpack_require__</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'use strict'</span>\n    <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'__webpack_require__.r(__webpack_exports__);\\n// sum.js\\n/* harmony default export */ __webpack_exports__[\"default\"] = (arr => arr.reduce((pre, item) => pre + item, 0));\\n\\n\\n//# sourceURL=webpack:///./src/sum.js?'</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">/***/</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>可以看出由 webpack 打包出来的是一个大大的 IIFE，上面一大堆是 webpack 自己实现的 commonjs 规范，下面的传参是我们的代码，可以看出 webpack 把我们的代码的每一个文件使用 IIFE 来做模块化，正式因为如此，问题出来了。</p>\n<p><strong>大量的函数闭包包裹代码，导致体积增大，模块越来越明显，运行代码时创建的函数作用域变多，导致内存开销变大。</strong></p>\n<p>解决上面问题的方法就是 scope hoisting</p>\n<h2>Scope hoisting</h2>\n<p>使用 scope hoisting 有两种方式：</p>\n<ul>\n<li>使用 webpack 自带的 ModuleConcatenationPlugin 插件开启</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">webpack<span class=\"token punctuation\">.</span>optimize<span class=\"token punctuation\">.</span>ModuleConcatenationPlugin</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>webpack 构建项目生产环境默认开启(mode:production)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">module<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  mode<span class=\"token punctuation\">:</span> <span class=\"token string\">'production'</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>启动一下先来看打包结果</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token punctuation\">;</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">modules</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> installedModules <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">function</span> <span class=\"token function\">__webpack_require__</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">moduleId</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>exports\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">var</span> module <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>installedModules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      i<span class=\"token punctuation\">:</span> moduleId<span class=\"token punctuation\">,</span>\n      l<span class=\"token punctuation\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n      exports<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    modules<span class=\"token punctuation\">[</span>moduleId<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span>\n      module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n      module<span class=\"token punctuation\">,</span>\n      module<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">,</span>\n      __webpack_require__\n    <span class=\"token punctuation\">)</span>\n\n    module<span class=\"token punctuation\">.</span>l <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token keyword\">return</span> module<span class=\"token punctuation\">.</span>exports\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token function\">__webpack_require__</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>__webpack_require__<span class=\"token punctuation\">.</span>s <span class=\"token operator\">=</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/***/</span> <span class=\"token string\">'./src/index.js'</span><span class=\"token punctuation\">:</span> <span class=\"token comment\">/***/</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span>\n    <span class=\"token parameter\">module<span class=\"token punctuation\">,</span>\n    __webpack_exports__<span class=\"token punctuation\">,</span>\n    __webpack_require__</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">'use strict'</span>\n    <span class=\"token function\">eval</span><span class=\"token punctuation\">(</span>\n      <span class=\"token string\">'__webpack_require__.r(__webpack_exports__);\\n\\n// CONCATENATED MODULE: ./src/sum.js\\n// sum.js\\n/* harmony default export */ var sum = (arr => arr.reduce((pre, item) => pre + item, 0));\\n\\n// CONCATENATED MODULE: ./src/add.js\\n// add.js\\n/* harmony default export */ var add = ((a, b) => a + b);\\n\\n// CONCATENATED MODULE: ./src/index.js\\n\\n\\n\\nlet a = 1,\\n  b = 2,\\n  arr = [1, 2, 3, 4, 5]\\n\\nconsole.log(add(a, b))\\nconsole.log(sum(arr))\\n\\n\\n//# sourceURL=webpack:///./src/index.js_+_2_modules?'</span>\n    <span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">/***/</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>你会发现，使用 scope hoisting 方式，IIFE 变成一个了(原来有 3 个)，add.js 和 sum.js 里面的代码被打包到 了 index.js 中，减少了 IIFE 的数量。</p>\n<blockquote>\n<p>原理： scope hoisting 将所有引入的模块按照顺序放在一个函数作用域里面，然后适当的重命名一些变量以防止变量名冲突。(总结一句：引用一次就内联进来，减少 IIFE 的数量)</p>\n</blockquote>\n<h2>总结</h2>\n<p>以上就是 IIFE 的使用方式，对比一下没有 scope hoisting 的状态：减少了函数声明代码从而减少了函数作用域的生成，降低了内存开销。</p>","frontmatter":{"title":"Webpack模块化的问题及Scope hoisting原理","date":"October 11, 2019","description":"分析webpack产出文件js模块化的问题，探究Scope hoisting怎么解决","category":"Webpack"}}},"pageContext":{"slug":"/content/Webpack/webpack-scope-hoisting/","previous":{"fields":{"slug":"/content/Webpack/webpack-mpa-solution/"},"frontmatter":{"title":"webpack多页面打包方案"}},"next":{"fields":{"slug":"/content/Test/optimize-test-benchmark/"},"frontmatter":{"title":"Benchmark写性能测试"}}}}}