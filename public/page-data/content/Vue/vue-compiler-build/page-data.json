{"componentChunkName":"component---src-templates-blog-post-js","path":"/content/Vue/vue-compiler-build/","result":{"data":{"site":{"siteMetadata":{"title":"Kim Blog","author":"Kim"}},"markdownRemark":{"id":"d77c60db-e99d-5305-a640-d9e8fe2a8901","excerpt":"整体 build 过程 执行 npm run build 得到各平台的 rollup 配置信息 通过终端传入的构建平台或环境，过滤掉不需要构建的平台配置 递归同步构建 写入文件  build npm run build 执行命令，会定位到 scripts 下的 build…","html":"<h3>整体 build 过程</h3>\n<ol>\n<li>执行 npm run build</li>\n<li>得到各平台的 rollup 配置信息</li>\n<li>通过终端传入的构建平台或环境，过滤掉不需要构建的平台配置</li>\n<li>递归同步构建</li>\n<li>写入文件</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/318879e6aa281d814d89727a7f272bc3/4c6ed/1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 97.0125786163522%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsSAAALEgHS3X78AAACZUlEQVQ4y41UaVMaQRTknySyO7vItRwChkNQPKIIyyEQRNBFjRI1V1mJmh/f6ZkFCzn98OrNzM70dr/XMx4jXIMIVWFE6vClWhAbDXhjNXijbmhxriebeN3HvCw8auN6BaFjBxH7CumTIUpfn1C5fWa8YLf3C+H6FfxbHQi//ebwvB+4gH4Clh0E813s1e7RdJ7RGrygffkPn+vfETjoI7DdVfsMawJQ5ilQFzBYhW+zheDRBcziKcThOUR5AD3HEnDu3+9BEEgP2NBUVCCYJZiYYuoZT+QGndKFWYaRaMPM9mBEmwjtXiJUcMjQ4XiA6ME1Yke3MLf6BKvOlMDzphZSTpB/3uzA3CbLbBex2gOS5W+wRkBpzjPNn/AVHSqz3f2MsXzPdFGVlNQXGNkzCKMELdrAWqIFjay9zB/jTXyIn0DfaKnQuCa4ZgRc0IWA5vYFGZ4hcHSDnH2PT8dDpMk0V71HofEDm6UhUqVbFNg06/AGYsd5B0Oy8xXOYck68oBVHHDMOu5fISzHjBhL4WcWLNNywFzPtUmyDZ1zIfN0cF2z6solqyWTmcj3EbLvsNP9gxSbUez9xW7/CfnOI7bav5E5fYS+c+E2ZtKHcxlmXCMrFqOQLNU3KW+cI41Xl4hVkg12UNllFKG9SwjeeSWPMqVtJsHmM5T0JRMJSPOmqg/IVu5Up+PssGIZXHynFzNM8wqul5UH1zaa0KTvYidzr9vMXZ5hyMOyhkb+HAk2JUmGBhskpRpzHoSFgDN/pRfD0nOsnfLlVL3ex3BSEtnqHOuWy2r8beUDu5SlnE+urXi1/wOhdYgwivtE+gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"1\"\n        title=\"1\"\n        src=\"/static/318879e6aa281d814d89727a7f272bc3/799d3/1.png\"\n        srcset=\"/static/318879e6aa281d814d89727a7f272bc3/00d96/1.png 148w,\n/static/318879e6aa281d814d89727a7f272bc3/0b23c/1.png 295w,\n/static/318879e6aa281d814d89727a7f272bc3/799d3/1.png 590w,\n/static/318879e6aa281d814d89727a7f272bc3/2a3d6/1.png 885w,\n/static/318879e6aa281d814d89727a7f272bc3/ae92f/1.png 1180w,\n/static/318879e6aa281d814d89727a7f272bc3/4c6ed/1.png 1272w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>build</h3>\n<blockquote>\n<p>npm run build</p>\n</blockquote>\n<p>执行命令，会定位到 scripts 下的 build 文件，下面来看一下这个文件中做了什么。</p>\n<p>首先会判断有没有 dist 目录，这是存放构建产出物的地方</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fs<span class=\"token punctuation\">.</span><span class=\"token function\">existsSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">mkdirSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>读取 config，获得各个平台或环境的 rollup 配置信息。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> builds <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./config'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getAllBuilds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>下面来看一下 config 文件做了什么。</p>\n<p>来到 config 定位到 getAllBuilds 方法</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">getAllBuilds</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>builds<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>genConfig<span class=\"token punctuation\">)</span></code></pre></div>\n<p>getAllBuilds 方法返回的是将一个对象的 key 变成数组并 map 映射了一下</p>\n<p><code class=\"language-text\">build</code>它就是存放的打包各个环境或平台的信息</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> builds <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token string\">'web-runtime-cjs-dev'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    entry<span class=\"token punctuation\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'web/entry-runtime.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    dest<span class=\"token punctuation\">:</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dist/vue.runtime.common.dev.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    format<span class=\"token punctuation\">:</span> <span class=\"token string\">'cjs'</span><span class=\"token punctuation\">,</span>\n    env<span class=\"token punctuation\">:</span> <span class=\"token string\">'development'</span><span class=\"token punctuation\">,</span>\n    banner\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-runtime-cjs-prod'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-cjs-dev'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-cjs-prod'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-runtime-esm'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-esm'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-esm-browser-dev'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-esm-browser-prod'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-runtime-dev'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-runtime-prod'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-dev'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-full-prod'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-compiler'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-compiler-browser'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-server-renderer-dev'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-server-renderer-prod'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-server-renderer-basic'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-server-renderer-webpack-server-plugin'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'web-server-renderer-webpack-client-plugin'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'weex-factory'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'weex-framework'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'weex-compiler'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>第一个配置中一共有 5 个属性</p>\n<ul>\n<li>entry</li>\n<li>dest</li>\n<li>format</li>\n<li>env</li>\n<li>banner</li>\n</ul>\n<p><strong>entry</strong></p>\n<p>entry 中调用 resolve 方法，resolve 方法通过对 node 的 path.resolve 封装了一下，用于找到构建的入口文件的路径。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> aliases <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./alias'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">resolve</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">p</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//得到是什么平台：vue有web平台和weex平台</span>\n  <span class=\"token keyword\">const</span> base <span class=\"token operator\">=</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// 通过平台拿到platforms下相应平台的目录，</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>aliases<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//拼接编译入口</span>\n    <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>aliases<span class=\"token punctuation\">[</span>base<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>base<span class=\"token punctuation\">.</span>length <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>__dirname<span class=\"token punctuation\">,</span> <span class=\"token string\">'../'</span><span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>dest</strong></p>\n<p>dest 中调用 resolve 与 entry 相同，用于找到构建后产出物所在的目录</p>\n<p><strong>format</strong></p>\n<p>format 表示构建完毕产出物的模块化规范是什么，rollup 用 format 来配置，一共有一下几种：</p>\n<ul>\n<li>amd</li>\n<li>cjs</li>\n<li>es</li>\n<li>iife</li>\n<li>umd</li>\n</ul>\n<p><strong>env</strong></p>\n<p>env 表示是以生产环境构建还是以开发环境构建，生产环境会进行代码 gzip 压缩</p>\n<p><strong>banner</strong></p>\n<p>源码往上翻可以看到这样一段代码</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> banner <span class=\"token operator\">=</span>\n  <span class=\"token string\">'/*!\\n'</span> <span class=\"token operator\">+</span>\n  <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> * Vue.js v</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>version<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\\n</span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">+</span>\n  ` <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span> <span class=\"token number\">2014</span><span class=\"token operator\">-</span>$<span class=\"token punctuation\">{</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getFullYear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span> Evan You\\n` <span class=\"token operator\">+</span>\n  <span class=\"token string\">' * Released under the MIT License.\\n'</span> <span class=\"token operator\">+</span>\n  <span class=\"token string\">' */'</span></code></pre></div>\n<p>用于在打包好的文件的顶部添加打包信息。</p>\n<p>回到 getAllBuilds 的话题，现在已经知道 builds 是什么了，下面调用 map 方法传入 genConfig 对原来的配置做了一下映射。</p>\n<p>来看一下 genConfig 做了什么</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">genConfig</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> opts <span class=\"token operator\">=</span> builds<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// rollup的配置结构</span>\n  <span class=\"token keyword\">const</span> config <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    input<span class=\"token punctuation\">:</span> opts<span class=\"token punctuation\">.</span>entry<span class=\"token punctuation\">,</span>\n    external<span class=\"token punctuation\">:</span> opts<span class=\"token punctuation\">.</span>external<span class=\"token punctuation\">,</span>\n    plugins<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token function\">flow</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">alias</span><span class=\"token punctuation\">(</span>Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> aliases<span class=\"token punctuation\">,</span> opts<span class=\"token punctuation\">.</span>alias<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>\n      opts<span class=\"token punctuation\">.</span>plugins <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      file<span class=\"token punctuation\">:</span> opts<span class=\"token punctuation\">.</span>dest<span class=\"token punctuation\">,</span>\n      format<span class=\"token punctuation\">:</span> opts<span class=\"token punctuation\">.</span>format<span class=\"token punctuation\">,</span>\n      banner<span class=\"token punctuation\">:</span> opts<span class=\"token punctuation\">.</span>banner<span class=\"token punctuation\">,</span>\n      name<span class=\"token punctuation\">:</span> opts<span class=\"token punctuation\">.</span>moduleName <span class=\"token operator\">||</span> <span class=\"token string\">'Vue'</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token function-variable function\">onwarn</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">msg<span class=\"token punctuation\">,</span> warn</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token regex\">/Circular/</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">warn</span><span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>了解 rollup 的应该都知道，builds 中的配置并不是 rollup 打包的配置信息，所以要把原来的配置映射成 rollup 的配置，genConfig 就是用来做这个的。</p>\n<p><strong>现在已经知道在 build 文件下调用 config 文件中的 getAllBuilds 得到的是什么。</strong></p>\n<p>接下来，拿到 shell 中输入的平台或环境信息，并且把不需要打包的 builds 中的配置过滤掉。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 解析shell 参数</span>\n  <span class=\"token keyword\">const</span> filters <span class=\"token operator\">=</span> process<span class=\"token punctuation\">.</span>argv<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">','</span><span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">//通过shell参数把builds不需要的平台配置过滤掉</span>\n  builds <span class=\"token operator\">=</span> builds<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">b</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> filters<span class=\"token punctuation\">.</span><span class=\"token function\">some</span><span class=\"token punctuation\">(</span>\n      <span class=\"token parameter\">f</span> <span class=\"token operator\">=></span> b<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">||</span> b<span class=\"token punctuation\">.</span>_name<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// filter out weex builds by default</span>\n  builds <span class=\"token operator\">=</span> builds<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">b</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> b<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'weex'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>执行 build 函数,开始构建</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">build</span><span class=\"token punctuation\">(</span>builds<span class=\"token punctuation\">)</span></code></pre></div>\n<p>由于存在多个不同或环境的编译构建，vue 采用同步 promise 的方式递归编译。类似于 koa 的中间件逻辑</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">builds</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> built <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">const</span> total <span class=\"token operator\">=</span> builds<span class=\"token punctuation\">.</span>length\n  <span class=\"token comment\">// 通过next 调用buildEntry同步编译，built对应builds中平台入口的索引，当一个编译完成之后，built++，继续启动next调用下一个。</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">next</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">buildEntry</span><span class=\"token punctuation\">(</span>builds<span class=\"token punctuation\">[</span>built<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        built<span class=\"token operator\">++</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>built <span class=\"token operator\">&lt;</span> total<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span>logError<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>其中调用 buildEntry，它是每一次构建入口，在这里会判断是否是生产环境从而在构建过程中使用 terser 压缩。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">buildEntry</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">config</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> output <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span>output\n  <span class=\"token comment\">// file是打包的入口</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> file<span class=\"token punctuation\">,</span> banner <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> output\n  <span class=\"token comment\">//isProd 判断是否是生产环境的编译</span>\n  <span class=\"token keyword\">const</span> isProd <span class=\"token operator\">=</span> <span class=\"token regex\">/(min|prod)\\.js$/</span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> rollup\n    <span class=\"token punctuation\">.</span><span class=\"token function\">rollup</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">bundle</span> <span class=\"token operator\">=></span> bundle<span class=\"token punctuation\">.</span><span class=\"token function\">generate</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> code <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// terser是一个适用于ES6压缩代码的工具，在生产环境对代码进行压缩</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isProd<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> minified <span class=\"token operator\">=</span>\n          <span class=\"token punctuation\">(</span>banner <span class=\"token operator\">?</span> banner <span class=\"token operator\">+</span> <span class=\"token string\">'\\n'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n          terser<span class=\"token punctuation\">.</span><span class=\"token function\">minify</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n            toplevel<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n            output<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n              ascii_only<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            compress<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n              pure_funcs<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'makeMap'</span><span class=\"token punctuation\">]</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>code\n        <span class=\"token keyword\">return</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> minified<span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>构建完毕之后最终调用 write 方法写入文件,在写入文件过程中会判断是否是生产环境的构建对产出物进行 gzip 压缩。</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">write</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dest<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> zip</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve<span class=\"token punctuation\">,</span> reject</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">function</span> <span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">extra</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>\n        <span class=\"token function\">blue</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">relative</span><span class=\"token punctuation\">(</span>process<span class=\"token punctuation\">.</span><span class=\"token function\">cwd</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dest<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n          <span class=\"token string\">' '</span> <span class=\"token operator\">+</span>\n          <span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span>\n          <span class=\"token punctuation\">(</span>extra <span class=\"token operator\">||</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n      <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// 将编译好的文件写入相应的目录下</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFile</span><span class=\"token punctuation\">(</span>dest<span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>zip<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">//gzip压缩</span>\n        zlib<span class=\"token punctuation\">.</span><span class=\"token function\">gzip</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> zipped</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">reject</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n          <span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token string\">' (gzipped: '</span> <span class=\"token operator\">+</span> <span class=\"token function\">getSize</span><span class=\"token punctuation\">(</span>zipped<span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">')'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">report</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>至此整个编译过程完毕。</p>","frontmatter":{"title":"Vue源码构建过程-不同平台&不同环境","date":"September 28, 2019","description":"深入源码探究Vue源代码的构建过程。","category":"Vue"}}},"pageContext":{"slug":"/content/Vue/vue-compiler-build/","previous":{"fields":{"slug":"/content/JavaScript/javascript-execution-context/"},"frontmatter":{"title":"深入了解JavaScript执行上下文"}},"next":{"fields":{"slug":"/content/Vue/vue-start-pre-newvue/"},"frontmatter":{"title":"浅析从加载到new Vue()--Vue做了什么？"}}}}}